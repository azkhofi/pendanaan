<!-- oauth2callback.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Authentication Complete</title>
    <meta charset="UTF-8">
</head>
<body>
    <script>
        function sendTokenToParent() {
            const hash = window.location.hash.substring(1);
            if (!hash) {
                console.error('No token found in URL');
                window.close();
                return;
            }

            const params = new URLSearchParams(hash);
            const access_token = params.get('access_token');
            const expires_in = params.get('expires_in');
            const error = params.get('error');
            const error_description = params.get('error_description');

            // Kirim pesan ke window yang membuka popup (opener)
            if (window.opener) {
                const message = {
                    type: 'google_auth_token',
                    token: access_token,
                    expires_in: expires_in ? parseInt(expires_in) : 3600,
                    error: error,
                    error_description: error_description
                };
                // Pastikan origin-nya cocok untuk keamanan
                window.opener.postMessage(message, window.location.origin);
                console.log('Token sent to parent window');
            } else {
                console.warn('No opener window found. User may have closed the main window.');
            }

            // Tutup popup setelah mengirim pesan (dengan sedikit jeda agar pesan terkirim)
            setTimeout(() => {
                window.close();
            }, 300);
        }

        // Jalankan saat halaman selesai dimuat
        window.onload = sendTokenToParent;
    </script>
    <p style="text-align: center; margin-top: 50px;">
        Authentication complete. You can close this window if it doesn't close automatically.
    </p>
</body>
</html>